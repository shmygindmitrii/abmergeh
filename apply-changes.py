import argparse
import shutil
from pathlib import Path


SECTION_ADDED = "ADDED"
SECTION_MODIFIED = "MODIFIED"
SECTION_DELETED = "DELETED"


def parse_changes_file(changes_path: Path) -> dict[str, list[str]]:
    """Parse output generated by get-changes.py into file lists."""
    result = {
        SECTION_ADDED: [],
        SECTION_MODIFIED: [],
        SECTION_DELETED: [],
    }

    current_section = None
    with changes_path.open("r", encoding="utf-8") as f:
        for raw_line in f:
            line = raw_line.strip()
            if not line:
                continue

            # Ignore any comment line.
            if line.startswith("//"):
                continue

            # Main section markers, e.g. [ADDED]: 2
            if line.startswith("[") and "]:" in line:
                section_name = line[1:].split("]:", 1)[0].strip()
                if section_name in result:
                    current_section = section_name
                # ignore extension buckets and unknown sections
                continue

            if current_section in (SECTION_ADDED, SECTION_MODIFIED, SECTION_DELETED):
                if ":" not in line:
                    continue
                rel_path = line.split(":", 1)[0].strip()
                if rel_path:
                    result[current_section].append(rel_path)

    return result


def copy_from_new(rel_path: str, old_root: Path, new_root: Path) -> None:
    src = new_root / rel_path
    dst = old_root / rel_path

    if not src.exists() or not src.is_file():
        raise FileNotFoundError(f"Source file does not exist in new_dir: {src}")

    dst.parent.mkdir(parents=True, exist_ok=True)
    shutil.copy2(src, dst)


def delete_in_old(rel_path: str, old_root: Path) -> None:
    target = old_root / rel_path
    if target.exists() and target.is_file():
        target.unlink()


def should_process_path(rel_path: str, include_extensions: set[str] | None) -> bool:
    if include_extensions is None:
        return True

    suffix = Path(rel_path).suffix.lower()
    if suffix.startswith("."):
        suffix = suffix[1:]

    return suffix in include_extensions


def apply_changes(
    old_dir: Path,
    new_dir: Path,
    changes_file: Path,
    include_extensions: set[str] | None,
) -> None:
    changes = parse_changes_file(changes_file)

    added = 0
    deleted = 0

    for rel_path in changes[SECTION_ADDED]:
        if not should_process_path(rel_path, include_extensions):
            continue
        copy_from_new(rel_path, old_dir, new_dir)
        added += 1

    # for rel_path in changes[SECTION_MODIFIED]:
    #     if not should_process_path(rel_path, include_extensions):
    #         continue
    #     copy_from_new(rel_path, old_dir, new_dir)

    for rel_path in changes[SECTION_DELETED]:
        if not should_process_path(rel_path, include_extensions):
            continue
        delete_in_old(rel_path, old_dir)
        deleted += 1
    
    print(f"Changes were applied from '{changes_file.as_posix()}': addded {added} file(s), deleted {deleted} file(s)")


def main() -> None:
    parser = argparse.ArgumentParser(
        description=(
            "Apply changes from a get-changes.py log: copy ADDED files "
            "from new_dir to old_dir and remove DELETED files from old_dir."
        )
    )
    parser.add_argument("old_dir", help="Directory to update")
    parser.add_argument("new_dir", help="Directory used as source for new/modified files")
    parser.add_argument("changes_file", help="Path to text output produced by get-changes.py")
    parser.add_argument(
        "--extensions",
        nargs="+",
        help="Process only listed extensions, e.g. --extensions py json md",
    )
    args = parser.parse_args()

    old_root = Path(args.old_dir).resolve()
    new_root = Path(args.new_dir).resolve()
    changes_path = Path(args.changes_file).resolve()

    if not old_root.exists() or not old_root.is_dir():
        raise SystemExit(f"old_dir does not exist or is not a directory: {old_root}")
    if not new_root.exists() or not new_root.is_dir():
        raise SystemExit(f"new_dir does not exist or is not a directory: {new_root}")
    if not changes_path.exists() or not changes_path.is_file():
        raise SystemExit(f"changes_file does not exist or is not a file: {changes_path}")

    include_extensions = None
    if args.extensions:
        include_extensions = {ext.lower().lstrip(".") for ext in args.extensions}

    apply_changes(old_root, new_root, changes_path, include_extensions)
    print("Changes were applied successfully.")


if __name__ == "__main__":
    main()
